---
sidebar_position: 30
---

# 信息流系统

## 功能性需求与核心指标

### 功能性需求
1. 用户浏览信息流
2. 用户发布信息流

### 核心指标
1. 浏览信息流的响应时间
2. 发布信息流的处理时间

## 基础架构

### 读阶段
<img src="https://cdn.jsdelivr.net/gh/Interview-Science/Book/static/img/system/newsfeed1.jpg" alt="newsfeed1" />

1. 客户端向服务端请求信息流
2. 服务端验证权限后，向数据库查询该用户订阅的信息流
3. 数据库聚合与去重后返回信息流列表（包括每个信息的 ID，信息文字内容，媒体数据缩略图），并返回给服务端
4. 服务端返回信息流列表给客户端
5. 客户端正常浏览信息流，当点击媒体详情（高清图，播放视频）时请求媒体存储获取数据

### 写阶段
<img src="https://cdn.jsdelivr.net/gh/Interview-Science/Book/static/img/system/newsfeed2.jpg" alt="newsfeed2" />

1. 客户端上传媒体资源与文字到服务端
2. 服务器将媒体资源上传到媒体存储
3. 媒体存储完成上传后通知服务器，如果成功，服务器更新数据库，并返回结果，如果失败直接返回给客户端

## 瓶颈分析

**核心问题：在请求信息流阶段，对于每位用户数据库需要进行复杂的多对多查询以及数据去重，效率低**

解决方案：对于活跃用户使用 Fanout 预生成信息流，并且缓存信息流

**次要问题：服务器，数据库等组件需要保证高可用**

解决方案：使用网络负载均衡保证分发到最佳服务器，使用 Replication 与 Failover 保证高可用

**次要问题：上传媒体资源需要经过服务器，服务器压力大并且占用大量带宽**

解决方案：直接上传到媒体存储（与登录相似，第一次上传时需要先通过服务器获取上传凭证 (Token)），之后使用该凭证直接上传到媒体存储

## 进阶架构

### 读阶段
<img src="https://cdn.jsdelivr.net/gh/Interview-Science/Book/static/img/system/newsfeed3.jpg" alt="newsfeed3" />

1. 消息队列推送信息流更新通知到客户端
2. 客户端通过负载均衡组件获取信息流数据
3. 负载均衡组件找到最合适的服务器
4. 服务器查询信息流缓存，有则直接返回，没有则从信息流数据库中获取并且更新到缓存中再返回，服务端返回结果给客户端
5. 客户端正常浏览信息流，当点击媒体详情（高清图，播放视频）时通过负载均衡组件向媒体存储请求数据

### 写阶段
<img src="https://cdn.jsdelivr.net/gh/Interview-Science/Book/static/img/system/newsfeed5.jpg" alt="newsfeed5" />

1. 客户端通过负载均衡组件上传媒体资源与文字
2. 负载均衡组件将媒体资源上传到媒体存储
3. 媒体存储返回上传状态给消息队列
4. 消息队列推送上传结果给服务端
5. 服务端根据上传结果处理请求，上传成功则更新数据库
6. 服务端返回发布结果到客户端
7. 服务端将需要更新的信息（用户 ID，文字，媒体资源 URL）发送到无服务器计算（Serverless Computing）
8. 无服务器计算写入信息到关注该用户的粉丝信息流数据库中

*注：如果不使用无服务器计算，第 7 步服务端会将信息发送给消息队列，消息队列通知分布式工作组，由该工作组负责第 8 步的更新。

## 瓶颈分析

**核心问题：对于热门用户，每发布一次信息就会造成大量的数据写入**

解决方案：使用混合策略，热门用户发布信息的时候不会写到其他用户的信息流中。客户端请求的时候先获取信息流内容，同时查询（热门用户的信息流会被缓存）关注的热门用户的信息流再进行聚合返回。

## 面试官可能提出的问题

- 大量的数据存储情况下，根据哪个纬度进行 Data Sharding ?
- 使用什么方法生成唯一 ID，使其既容易生成也容易查询？
- 如果信息流不是根据时间，而是使用推荐算法来生成的话，需要如何调整此系统架构？
