---
sidebar_position: 35
---

# IM 系统

## 功能性需求与核心指标

### 功能性需求
1. 用户与用户收发信息
2. 用户与群组收发信息
3. 用户多客户端同步信息

### 核心指标
1. 获取与发布信息的响应时间
2. 信息的有序性以及一致性

## 基础架构

### 读阶段

![im1](/img/system/im1.svg)

1. 客户端向服务端请求消息
2. 服务端从数据库查询消息
3. 服务端返回消息给客户端


### 写阶段

![im2](/img/system/im2.svg)

1. 客户端向服务端发送消息
2. 服务端更新消息到数据库
3. 服务端返回结果

## 瓶颈分析

**核心问题：读阶段需要主动或定期查询新消息**

解决方案：使用专门为实时通信设计的应用层协议，如 XMPP 或者 MQTT，它们能够主动推送消息给客户端。

**次要问题：客户端没有存储消息列表，无法在离线情况下获取之前的消息**

解决方案：使用 SQLite 等本地数据库保存聊天记录

## 进阶架构

### 读阶段

![im3](/img/system/im3.svg)

1. 客户端上线
2. 聊天服务器发布用户上线事件
3. 服务端，状态服务器都订阅该事件
4. 服务端向日志数据库查询该用户的新消息
5. 服务端将用户新消息发布到消息队列
3. 聊天服务端订阅了新消息发布事件，将其推送给客户端


### 写阶段

![im4](/img/system/im4.svg)

1. 客户端使用实时通信协议与聊天服务端连接
2. 客户端发送消息给聊天服务器，客户端本地存储消息列表
3. 聊天服务端发送消息给消息队列
4. 服务端更新对应接受者的数据库

## 瓶颈分析

**核心问题：不同实时通信协议的优缺点**

解决方案：浏览：[8 Most Popular Instant Messaging & Chat Protocols](https://www.cometchat.com/blog/popular-chat-and-instant-messaging-protocols)

**次要问题：对于群组来说，发送消息可能会造成写放大，因为要写到所有群组成员的消息列表中**

解决方案：使用混合策略，当群组人数少于某个阈值时，使用原方案。反之，群组成员只会收到群组有消息的通知，收到通知后需要主动拉取消息。

## 面试官可能提出的问题

- 如何保证消息有序性，发送方与接收方的消息顺序是完全一致的？
- 如何维护用户在线状态？
- 如何实现已读回执功能？
